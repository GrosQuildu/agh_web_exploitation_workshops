#!/bin/bash

set -ex
cd /code

./wait-for-it.sh -t 0 db:3306 -- echo "db is up"

python ./manage.py migrate
python ./manage.py shell -c "from users.models import User, Secret; secret = Secret.objects.create(content='flag{very_b4sic_sql_injection}'); User.objects.create(username='admin', password='fm8932yem8x7nr8nGNAS', secret=secret) if not User.objects.filter(username='admin').exists() else secret.delete()"
mysql -u root -prootpassword -h db -e ' GRANT FILE ON *.* to sqli@"%";'

exec "$@"