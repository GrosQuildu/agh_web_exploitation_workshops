from app import app, db
from app.models import User, Post
from config import ADMIN_PASS, ADMIN_PATH, FLAG_IDOR, FLAG_IDOR_SLUG, MAGIC_FLAG, MAGIC_FLAG_SLUG


@app.shell_context_processor
def make_shell_context():
    return {'db': db, 'User': User, 'Post': Post}

def seed():
    admin = User.query.filter_by(username="admin").first()
    if not admin:
        admin = User(username="admin")
        admin.set_password(ADMIN_PASS)
        db.session.add(admin)
        db.session.commit()

    if not Post.query.filter_by(title="FLAG_IDOR").first():
        post = Post(title="FLAG_IDOR", content=FLAG_IDOR)
        post.update_slug_static(FLAG_IDOR_SLUG)
        admin.posts.append(post)
        db.session.commit()

    if not Post.query.filter_by(title="MAGIC_SLUG").first():
        post = Post(title="MAGIC_SLUG", content=MAGIC_FLAG)
        post.update_slug_hash(MAGIC_FLAG_SLUG)
        admin.posts.append(post)
        db.session.commit()


if __name__ == '__main__':
    seed()
    app.run(debug=False, host='0.0.0.0')