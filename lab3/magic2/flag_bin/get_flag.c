#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <libgen.h>


/* clang ./get_flag.c -o get_flag && strip -s get_flag */

char theTable[] = {'\x24','\xa5','\x95','\xe7','\x1f','\xdf','\x5d','\xb3','\x5b','\xcc','\xb2','\xc1','\x16','\x2d','\x82','\x8c','\xe5','\x64','\xd7','\xe7','\x34','\x96','\x8a','\xef','\x88'};

int main(int argc, char const *argv[])
{
    if (argc != 2) {
        fprintf(stderr, "Wrong number of arguments\nGot %d args\n", argc-1);
        for (int i = 1; i < argc; ++i)
        {
            fprintf(stderr, "arg %d: '%s'\n", i, argv[i]);
        }
        return 1;
    }

    if ((strlen(argv[1]) == 6 && strncmp(argv[1], "--help", 6) == 0) || 
            (strlen(argv[1]) == 2 && strncmp(argv[1], "-h", 2) == 0)) {
        printf("Usage: %s --cast spell (and the spell on stdin)\n", argv[0]);
        return 0;
    }

    if (strlen(argv[1]) != 12 || strncmp(argv[1], "--cast spell", 12) != 0) {
        fprintf(stderr, "Argument is not '--cast spell'\nIt is: '%s'\n", argv[1]);
        return 1;
    }

    char theSpell[11] = {};
    int readed = read(STDIN_FILENO, theSpell, 10);
    theSpell[10] = '\x00';
    if (readed != 10 || strncmp(theSpell, "gimme flag", 10) != 0) {
        fprintf(stderr, "The spell is wrong\nYou casted '%s'\n", theSpell);
        fprintf(stderr, "I only know 'gimme flag'\n");
        return 1;
    }

    printf("Casting '%s'\n", theSpell);

    char flagFileBinPath[1024] = {};
    ssize_t flagFileBinPathResult = readlink("/proc/self/exe", flagFileBinPath, 1010);
    if (flagFileBinPathResult == -1) {
        fprintf(stderr, "Cast failed, contact me, code:1\n");
        return 1;
    }

    char *flagFileDir = dirname(flagFileBinPath);
    char flagFilePath[1024] = {};
    strncpy(flagFilePath, flagFileDir, 1010);
    strncpy(flagFilePath+strlen(flagFilePath), "/flag2.txt", 11);

    FILE *flagFile = fopen(flagFilePath, "r");
    if (flagFile == NULL) {
        fprintf(stderr, "Cast failed, contact me, code:2\n");
        printf("%s\n",flagFilePath);
        return 1;
    }

    char flag[101] = {};
    int flagReaded = fread(flag, 1, 100, flagFile);
    fclose(flagFile);

    if (flagReaded <= 0) {
        fprintf(stderr, "Cast failed, contact me, code:3\n");
        return 1;
    }

    int flagLength = sizeof(theTable);
    int i;
    for (i = 0; i < flagLength; ++i)
    {
        flag[i] ^= theTable[i];
    }
    flag[i] = '\x00';

    printf("Cast result: %s\n", flag);

    return 0;
}