var apiPath = "/lab3/magic2/chat/"
var msgOffset = 0
var nickGlobal = "+guest" + Math.floor(Math.random() * 10000);

function addZero(i) {
    if (i < 10) {
        i = "0" + i;
    }
    return i;
}

function insertText(input, nick=-2, send=false, date=null) {
    if ( input.length > 0 ) {
        var conversationPanel = document.getElementById("channelText"); 

        if (nick == -2) {
            nick = ""
        } else if (nick == -1) {
            nick = nickGlobal
        }

        var ircOutputTime = date
        if (date == null) {
            var hourInput = new Date();
            ircOutputTime = addZero(hourInput.getHours()) + ":" + addZero(hourInput.getMinutes());
        }

        if (send) {
            var inputUserText = document.getElementById('inputUser');
            var logChat = new XMLHttpRequest();
            logChat.open('GET', apiPath + 'write?msg=' +
                                encodeURIComponent(inputUserText.value) +
                                "&nick=" + encodeURIComponent(nick) +
                                "&date=" + encodeURIComponent(hourInput.valueOf()), true);
            logChat.send(null);
            inputUserText.value = "";

        } else {
            conversationPanel.textContent +=  "\n" + "[" + ircOutputTime + "] " + "<" + nick + "> " + input;
            conversationPanel.scrollTop = conversationPanel.scrollHeight;
        }
    };
};

function downloadMessages() {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE) {
           if (xmlhttp.status == 200) {
                var messages = JSON.parse(xmlhttp.responseText)
                msgOffset += messages.length
                messages.forEach(function (message, index) {
                    insertText(message['Content'], nick=message['Nick'],
                                send=false, date=message['Date'])
                });
           }
           else {
              console.log('There was an error ' + xmlhttp.status +
                            ' with offset ' + msgOffset);
           }
        }
    };

    xmlhttp.open("GET", apiPath + 'read?offset=' + msgOffset, true);
    xmlhttp.send(null);
}

function updateNicks(argument) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE) {
           if (xmlhttp.status == 200) {
                var usersPanel = document.getElementById("nicksFrame"); 
                var users = JSON.parse(xmlhttp.responseText)

                usersPanel.innerText = ''
                users.forEach(function (user, index) {
                    usersPanel.innerText += user['Nick'];
                    usersPanel.innerHTML += "<br/>";
                });
           }
           else {
              console.log('There was an error ' + xmlhttp.status +
                            ' with offset ' + msgOffset);
           }
        }
    };

    xmlhttp.open("GET", apiPath + 'users', true);
    xmlhttp.send(null);

}

function setNick(nick) {
    nickGlobal = nick
    var inputUserText = document.getElementById('inputUser');
    inputUserText.value = "";
}

function startChat(){
    var conversationPanel = document.getElementById("channelText");
    var iframeNicks = document.getElementById('nicksFrame');
    var channelText = document.getElementById('channelText');

    setTimeout(function(){insertText("* Looking up irc.aghws.jhtc.net");}, 1000);
    conversationPanel.scrollTop = conversationPanel.scrollHeight;

    setTimeout(function(){insertText("* Connecting to irc.aghws.jhtc.net (13.73.73.13) port 777...");}, 2000);

    setTimeout(function(){
        var jctfText = ''
        var xhrIrcd = new XMLHttpRequest();
        xhrIrcd.open('GET', '/lab3/magic2/logo', true);
        xhrIrcd.onload = function(){
          jctfText = xhrIrcd.responseText;
          insertText(jctfText);
          conversationPanel.scrollTop = conversationPanel.scrollHeight;

          setTimeout(function(){conversationPanel.textContent +=  "\n" + "* joining #AGH-magic2" + "\n";
          conversationPanel.scrollTop = conversationPanel.scrollHeight;}, 1000);

          setTimeout(function(){channelText.setAttribute('style','overflow-y: scroll;')},1400);
          setTimeout(function(){iframeNicks.setAttribute('style','display: block');},4000);

          setTimeout(function(){insertText("Welcome my friend!","@sroG");
          conversationPanel.scrollTop = conversationPanel.scrollHeight;}, 5000);

          setTimeout(function(){insertText("/nick newNickName to login","help");
          conversationPanel.scrollTop = conversationPanel.scrollHeight;}, 5500);

          setInterval(downloadMessages, 1000);
          setInterval(updateNicks, 1000);
        }
        xhrIrcd.send(null);
    }, 4000);
};

