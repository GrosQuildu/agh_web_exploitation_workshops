FROM ruby:2.5

RUN useradd -ms /bin/bash rails
USER rails
COPY --chown=rails . /home/rails/subdomains
WORKDIR /home/rails/subdomains
ENV RAILS_ENV production
RUN gem install bundler -v 2.0.2
RUN gem install rake -v 13.0.1
USER root
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN  apt -y update && apt -y install yarn
USER rails
RUN bundle install
RUN rake db:reset
RUN rake db:migrate

EXPOSE 3000
ENTRYPOINT [ "./entrypoint.sh" ]