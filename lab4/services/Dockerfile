FROM ubuntu:16.04

ARG username=demo
USER root
RUN apt-get update && apt-get -y install build-essential zlib1g-dev libssl-dev supervisor wget apt-transport-https

# install openssl 1.0.2
COPY openssl-1.0.2t.tar.gz /openssl-1.0.2t.tar.gz
RUN tar -xzvf openssl-1.0.2t.tar.gz
WORKDIR /openssl-1.0.2t
RUN ./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl shared zlib && make && make install

# install openssh 7.7
RUN groupadd sshd
RUN useradd -g sshd -c sshd -d / sshd
WORKDIR /
COPY openssh-7.7p1.tar.gz /openssh-7.7p1.tar.gz
RUN tar -xzvf openssh-7.7p1.tar.gz
WORKDIR /openssh-7.7p1
RUN ./configure && make && make install
RUN useradd -ms /bin/bash ${username}
RUN echo "${username}:`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`" | chpasswd
RUN mkdir /home/${username}/.ssh && chmod 0700 /home/${username}/.ssh
RUN mkdir -p /var/run/sshd
RUN mkdir /etc/ssh
RUN echo "StrictModes no" >> /etc/ssh/sshd_config

# install mongo
WORKDIR /
RUN wget -qO - https://www.mongodb.org/static/pgp/server-4.2.asc | apt-key add -
RUN echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/4.2 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-4.2.list
RUN apt-get update
RUN apt-get install -y mongodb-org
RUN mkdir -p /data/db
ARG mongo_password=gwerty123
RUN echo "db.createUser({ \
    user: '${username}', \
    pwd: '${mongo_password}', \
    roles: [ \
        { role: 'read', db: 'flag'}, \
        { role: 'read', db: 'admin'} \
    ] \
});" > /addMongoUser.js
COPY mongoSeed.json /mongoSeed.json
RUN /usr/bin/mongod --fork --logpath /var/log/mongodb.log -f /etc/mongod.conf && mongo admin < /addMongoUser.js

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf


EXPOSE 22 27017
CMD ["/usr/bin/supervisord"]
