FROM ubuntu:16.04

ARG username=prime
USER root
RUN apt-get update && apt-get -y install build-essential zlib1g-dev libssl-dev supervisor apt-transport-https

# install openssl 1.0.2
COPY openssl-1.0.2t.tar.gz /openssl-1.0.2t.tar.gz
RUN tar -xzvf openssl-1.0.2t.tar.gz
WORKDIR /openssl-1.0.2t
RUN ./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl shared zlib && make && make install

# install openssh 7.7
RUN groupadd sshd
RUN useradd -g sshd -c sshd -d / sshd
WORKDIR /
COPY openssh-7.7p1.tar.gz /openssh-7.7p1.tar.gz
RUN tar -xzvf openssh-7.7p1.tar.gz
WORKDIR /openssh-7.7p1
RUN ./configure && make && make install
RUN useradd -ms /bin/bash ${username}
RUN echo "${username}:`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`" | chpasswd
RUN mkdir /home/${username}/.ssh && chmod 0700 /home/${username}/.ssh
RUN mkdir -p /var/run/sshd
RUN mkdir /etc/ssh
RUN echo "StrictModes no" >> /etc/ssh/sshd_config

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf